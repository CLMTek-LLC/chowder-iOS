# =============================================================================
# Shelly iOS — TestFlight CI/CD Pipeline
# =============================================================================
#
# Builds the Shelly iOS app and uploads to TestFlight on every push to main.
# Uses App Store Connect API key for automatic signing — no provisioning
# profiles to manage. Xcode auto-registers bundle IDs when API key has
# App Manager role in App Store Connect.
#
# Required GitHub repository secrets:
#   APPLE_API_KEY_BASE64  — base64 -i AuthKey_L28MWL7HC9.p8
#   APPLE_API_KEY_ID      — L28MWL7HC9
#   APPLE_ISSUER_ID       — 69a6de6e-6108-47e3-e053-5b8c7c11a4d1
#   APPLE_TEAM_ID         — T2H2YPQXA9
#
# =============================================================================

name: Build & Deploy to TestFlight

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: testflight-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-upload:
    name: Build & Upload to TestFlight
    runs-on: macos-latest
    timeout-minutes: 45

    env:
      SCHEME: Chowder
      PROJECT: Chowder/Chowder.xcodeproj
      ARCHIVE_PATH: ./build/Shelly.xcarchive
      EXPORT_PATH: ./build/export
      BUILD_NUMBER_OFFSET: 51

    steps:
      # -----------------------------------------------------------------------
      # 1. Checkout
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # 2. Select Xcode 26 (required for FoundationModels)
      # -----------------------------------------------------------------------
      - name: Set up Xcode 26
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26'

      # -----------------------------------------------------------------------
      # 3. Install App Store Connect API key
      #    Use $HOME (absolute path) — xcodebuild rejects ~ tilde paths
      # -----------------------------------------------------------------------
      - name: Install App Store Connect API key
        env:
          API_KEY_BASE64: ${{ secrets.APPLE_API_KEY_BASE64 }}
          API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
        run: |
          KEY_DIR="$HOME/.private_keys"
          mkdir -p "$KEY_DIR"
          echo "$API_KEY_BASE64" | base64 --decode > "$KEY_DIR/AuthKey_${API_KEY_ID}.p8"
          echo "API key installed"

      # -----------------------------------------------------------------------
      # 4. Calculate build number (starts at 60)
      #    Uses shell arithmetic: run_number + offset
      # -----------------------------------------------------------------------
      - name: Calculate build number
        run: |
          BUILD_NUM=$(( ${{ github.run_number }} + $BUILD_NUMBER_OFFSET ))
          echo "BUILD_NUMBER=$BUILD_NUM" >> "$GITHUB_ENV"
          echo "Build number: $BUILD_NUM (run ${{ github.run_number }} + offset $BUILD_NUMBER_OFFSET)"

      # -----------------------------------------------------------------------
      # 5. Build & archive for iOS
      #    - destination=generic/platform=iOS ensures iOS (not macOS) target
      #    - allowProvisioningUpdates auto-registers bundle ID + profiles
      # -----------------------------------------------------------------------
      - name: Archive Shelly.xcarchive
        env:
          API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          ISSUER_ID: ${{ secrets.APPLE_ISSUER_ID }}
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          KEY_PATH="$HOME/.private_keys/AuthKey_${API_KEY_ID}.p8"
          xcodebuild archive \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath "$ARCHIVE_PATH" \
            -allowProvisioningUpdates \
            -authenticationKeyPath "$KEY_PATH" \
            -authenticationKeyID "$API_KEY_ID" \
            -authenticationKeyIssuerID "$ISSUER_ID" \
            CODE_SIGN_STYLE=Automatic \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            CURRENT_PROJECT_VERSION="$BUILD_NUMBER" \
            MARKETING_VERSION="1.0.$BUILD_NUMBER"

      # -----------------------------------------------------------------------
      # 6. Create ExportOptions.plist
      # -----------------------------------------------------------------------
      - name: Create ExportOptions.plist
        env:
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cat > ExportOptions.plist << PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store-connect</string>
            <key>teamID</key>
            <string>${TEAM_ID}</string>
            <key>uploadSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
          </dict>
          </plist>
          PLIST

      # -----------------------------------------------------------------------
      # 7. Export IPA
      # -----------------------------------------------------------------------
      - name: Export IPA
        env:
          API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          ISSUER_ID: ${{ secrets.APPLE_ISSUER_ID }}
        run: |
          KEY_PATH="$HOME/.private_keys/AuthKey_${API_KEY_ID}.p8"
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath "$EXPORT_PATH" \
            -exportOptionsPlist ExportOptions.plist \
            -allowProvisioningUpdates \
            -authenticationKeyPath "$KEY_PATH" \
            -authenticationKeyID "$API_KEY_ID" \
            -authenticationKeyIssuerID "$ISSUER_ID"

      # -----------------------------------------------------------------------
      # 8. Upload to TestFlight
      # -----------------------------------------------------------------------
      - name: Upload to TestFlight
        env:
          API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          ISSUER_ID: ${{ secrets.APPLE_ISSUER_ID }}
        run: |
          xcrun altool --upload-app \
            --type ios \
            --file "$EXPORT_PATH/Shelly.ipa" \
            --apiKey "$API_KEY_ID" \
            --apiIssuer "$ISSUER_ID"
